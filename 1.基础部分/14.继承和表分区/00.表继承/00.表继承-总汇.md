# 表继承（pg_version:11.2）
```
    1) 创建一张父表，然后创建一张子表来继承父表。关键字：INHERITS
    2) 使用 alter table inherit。将一个已经创建的表实现继承关系。
    3) 使用 alter table no inherit 来移除继承关系。
```
## 创建继承表 - 新建表
### 单表继承
```
      DROP TABLE IF EXISTS "foo";
      CREATE TABLE IF NOT EXISTS "foo"(
      "id" int primary key,
      "name" text,
      "work" text
      )
      WITH(OIDS=FALSE);

      DROP TABLE IF EXISTS "son";
      CREATE TABLE IF NOT EXISTS "son"(
      )inherits(foo)
      WITH(OIDS=FALSE);

      postgres=# \d+ foo
                                        Table "public.foo"
      Column |  Type   | Collation | Nullable | Default | Storage  | Stats target | Description
      -------+---------+-----------+----------+---------+----------+--------------+-------------
      id     | integer |           | not null |         | plain    |              |
      name   | text    |           |          |         | extended |              |
      work   | text    |           |          |         | extended |              |
      Indexes:
        "foo_pkey" PRIMARY KEY, btree (id)
      Child tables: son

      postgres=# \d+ son
                                        Table "public.son"
      Column |  Type   | Collation | Nullable | Default | Storage  | Stats target | Description
      -------+---------+-----------+----------+---------+----------+--------------+-------------
      id     | integer |           | not null |         | plain    |              |
      name   | text    |           |          |         | extended |              |
      work   | text    |           |          |         | extended |              |
      Inherits: foo
```
### 多表继承
```
      DROP TABLE IF EXISTS "foo";
      CREATE TABLE IF NOT EXISTS "foo"(
      "id" int primary key,
      "name" text,
      "work" text
      )
      WITH(OIDS=FALSE);

      DROP TABLE IF EXISTS "foo_2";
      CREATE TABLE IF NOT EXISTS "foo_2"(
      "id" int primary key,
      "name" text,
      "school" text
      )
      WITH(OIDS=FALSE);

      DROP TABLE IF EXISTS "son";
      CREATE TABLE IF NOT EXISTS "son"(
      )inherits(foo, foo_2)
      WITH(OIDS=FALSE);


      postgres=# \d+ foo
                                    Table "public.foo"
       Column |  Type   | Collation | Nullable | Default | Storage  | Stats target | Description
      --------+---------+-----------+----------+---------+----------+--------------+-------------
       id     | integer |           | not null |         | plain    |              |
       name   | text    |           |          |         | extended |              |
       work   | text    |           |          |         | extended |              |
      Indexes:
          "foo_pkey" PRIMARY KEY, btree (id)
      Child tables: son

      postgres=# \d+ foo_2
                                         Table "public.foo_2"
       Column |  Type   | Collation | Nullable | Default | Storage  | Stats target | Description
      --------+---------+-----------+----------+---------+----------+--------------+-------------
       id     | integer |           | not null |         | plain    |              |
       name   | text    |           |          |         | extended |              |
       school | text    |           |          |         | extended |              |
      Indexes:
          "foo_2_pkey" PRIMARY KEY, btree (id)
      Child tables: son

      postgres=# \d+ son
                                          Table "public.son"
       Column |  Type   | Collation | Nullable | Default | Storage  | Stats target | Description
      --------+---------+-----------+----------+---------+----------+--------------+-------------
       id     | integer |           | not null |         | plain    |              |
       name   | text    |           |          |         | extended |              |
       work   | text    |           |          |         | extended |              |
       school | text    |           |          |         | extended |              |
      Inherits: foo,
                foo_2

    -----------------------------------------------------------------------------------------------------
    案例2：
    CREATE TABLE IF	NOT EXISTS persons (
    --"name" TEXT DEFAULT 'zhangsan',
    "sex" BOOLEAN DEFAULT TRUE,
    "age" INT CHECK(age>5)
    );

    CREATE TABLE IF	NOT EXISTS persons_2 (
    --"name" TEXT DEFAULT 'lisi',
    "sex" BOOLEAN DEFAULT TRUE,
    "age" INT CHECK(age<10)
    );

    CREATE TABLE IF	NOT EXISTS students (
    "name" TEXT,
    "sex" BOOLEAN,
    "age" INT
    ) inherits(persons,persons_2);

    postgres=# \d+ persons_2
                                 Table "public.persons_2"
 Column |  Type   | Collation | Nullable | Default | Storage | Stats target | Description
--------+---------+-----------+----------+---------+---------+--------------+-------------
 sex    | boolean |           |          | true    | plain   |              |
 age    | integer |           |          |         | plain   |              |
Check constraints:
    "persons_2_age_check" CHECK (age < 10)
Child tables: students

postgres=# \d+ students
                                  Table "public.students"
 Column |  Type   | Collation | Nullable | Default | Storage  | Stats target | Description
--------+---------+-----------+----------+---------+----------+--------------+-------------
 sex    | boolean |           |          | true    | plain    |              |
 age    | integer |           |          |         | plain    |              |
 name   | text    |           |          |         | extended |              |
Check constraints:
    "persons_2_age_check" CHECK (age < 10)
    "persons_age_check" CHECK (age > 5)
Inherits: persons,
          persons_2

```

## 创建继承表 - 修改表
### 主表增加新的字段
```
    create table if not exists persons(
    "name" text,
    "sex" boolean,
    "age" int
    )with(oids=false);

    create table if not exists students(
    "class_name" text
    )inherits(persons)
    with(oids=false);


      PgLearn=# \d
                      关联列表
       架构模式 |   名称   |  类型  |  拥有者
      ----------+----------+--------+----------
       public   | persons  | 数据表 | postgres
       public   | students | 数据表 | postgres
      (2 行记录)

      PgLearn=# \d+ persons
                              数据表 "public.persons"
       栏位 |  类型   | 校对规则 | 可空的 | 预设 |   存储   | 统计目标 | 描述
      ------+---------+----------+--------+------+----------+----------+------
       name | text    |          |        |      | extended |          |
       sex  | boolean |          |        |      | plain    |          |
       age  | integer |          |        |      | plain    |          |
      子表: students

      PgLearn=# \d+ students
                                 数据表 "public.students"
          栏位    |  类型   | 校对规则 | 可空的 | 预设 |   存储   | 统计目标 | 描述
      ------------+---------+----------+--------+------+----------+----------+------
       name       | text    |          |        |      | extended |          |
       sex        | boolean |          |        |      | plain    |          |
       age        | integer |          |        |      | plain    |          |
       class_name | text    |          |        |      | extended |          |
      继承: persons

      在主表中加入字段。
      PgLearn=# alter table persons add column id bigserial primary key;
      ALTER TABLE
      PgLearn=# \d+ persons
                                               数据表 "public.persons"
       栏位 |  类型   | 校对规则 |  可空的  |                预设                 |   存储   | 统计目标 | 描述
      ------+---------+----------+----------+-------------------------------------+----------+----------+------
       name | text    |          |          |                                     | extended |          |
       sex  | boolean |          |          |                                     | plain    |          |
       age  | integer |          |          |                                     | plain    |          |
       id   | bigint  |          | not null | nextval('persons_id_seq'::regclass) | plain    |          |
      索引：
          "persons_pkey" PRIMARY KEY, btree (id)
      子表: students


      PgLearn=# \d+ students
                                                 数据表 "public.students"
          栏位    |  类型   | 校对规则 |  可空的  |                预设                 |   存储   | 统计目标 | 描述
      ------------+---------+----------+----------+-------------------------------------+----------+----------+------
       name       | text    |          |          |                                     | extended |          |
       sex        | boolean |          |          |                                     | plain    |          |
       age        | integer |          |          |                                     | plain    |          |
       class_name | text    |          |          |                                     | extended |          |
       id         | bigint  |          | not null | nextval('persons_id_seq'::regclass) | plain    |          |
      继承: persons

      子表也会增加该字段，但是主键约束不会继承。约束的继承规则参照本章后面内容。序列也会继承。
```
### 删除主表字段
```
postgres=# \d+ p
                                                Table "public.p"
 Column |  Type   | Collation | Nullable |            Default            | Storage  | Stats target | Description
--------+---------+-----------+----------+-------------------------------+----------+--------------+-------------
 name   | text    |           |          |                               | extended |              |
 sex    | boolean |           |          |                               | plain    |              |
 age    | integer |           |          |                               | plain    |              |
 id     | bigint  |           | not null | nextval('p_id_seq'::regclass) | plain    |              |
Indexes:
    "p_pkey" PRIMARY KEY, btree (id)
Child tables: students
Options: fillfactor=60, parallel_workers=5

postgres=# \d+ students
                                               Table "public.students"
   Column   |  Type   | Collation | Nullable |            Default            | Storage  | Stats target | Description
------------+---------+-----------+----------+-------------------------------+----------+--------------+-------------
 name       | text    |           |          |                               | extended |              |
 sex        | boolean |           |          |                               | plain    |              |
 age        | integer |           |          |                               | plain    |              |
 class_name | text    |           |          |                               | extended |              |
 id         | bigint  |           | not null | nextval('p_id_seq'::regclass) | plain    |              |
Inherits: p
Child tables: chinese_students

postgres=# \d+ chinese_students
                                           Table "public.chinese_students"
   Column   |  Type   | Collation | Nullable |            Default            | Storage  | Stats target | Description
------------+---------+-----------+----------+-------------------------------+----------+--------------+-------------
 name       | text    |           |          |                               | extended |              |
 sex        | boolean |           |          |                               | plain    |              |
 age        | integer |           |          |                               | plain    |              |
 class_name | text    |           |          |                               | extended |              |
 id         | bigint  |           | not null | nextval('p_id_seq'::regclass) | plain    |              |
Inherits: students

postgres=# alter table p drop column sex;
ALTER TABLE
postgres=# \d+ chinese_students
                                           Table "public.chinese_students"
   Column   |  Type   | Collation | Nullable |            Default            | Storage  | Stats target | Description
------------+---------+-----------+----------+-------------------------------+----------+--------------+-------------
 name       | text    |           |          |                               | extended |              |
 age        | integer |           |          |                               | plain    |              |
 class_name | text    |           |          |                               | extended |              |
 id         | bigint  |           | not null | nextval('p_id_seq'::regclass) | plain    |              |
Inherits: students

postgres=# \d+ students
                                               Table "public.students"
   Column   |  Type   | Collation | Nullable |            Default            | Storage  | Stats target | Description
------------+---------+-----------+----------+-------------------------------+----------+--------------+-------------
 name       | text    |           |          |                               | extended |              |
 age        | integer |           |          |                               | plain    |              |
 class_name | text    |           |          |                               | extended |              |
 id         | bigint  |           | not null | nextval('p_id_seq'::regclass) | plain    |              |
Inherits: p
Child tables: chinese_students

```

### 删除子表继承来的字段
```
postgres=# \d+ p
                                                Table "public.p"
 Column |  Type   | Collation | Nullable |            Default            | Storage  | Stats target | Description
--------+---------+-----------+----------+-------------------------------+----------+--------------+-------------
 name   | text    |           |          |                               | extended |              |
 sex    | boolean |           |          |                               | plain    |              |
 age    | integer |           |          |                               | plain    |              |
 id     | bigint  |           | not null | nextval('p_id_seq'::regclass) | plain    |              |
Indexes:
    "p_pkey" PRIMARY KEY, btree (id)
Child tables: students
Options: fillfactor=60, parallel_workers=5

postgres=# \d+ students
                                               Table "public.students"
   Column   |  Type   | Collation | Nullable |            Default            | Storage  | Stats target | Description
------------+---------+-----------+----------+-------------------------------+----------+--------------+-------------
 name       | text    |           |          |                               | extended |              |
 sex        | boolean |           |          |                               | plain    |              |
 age        | integer |           |          |                               | plain    |              |
 class_name | text    |           |          |                               | extended |              |
 id         | bigint  |           | not null | nextval('p_id_seq'::regclass) | plain    |              |
Inherits: p
Child tables: chinese_students

postgres=# \d+ chinese_students
                                           Table "public.chinese_students"
   Column   |  Type   | Collation | Nullable |            Default            | Storage  | Stats target | Description
------------+---------+-----------+----------+-------------------------------+----------+--------------+-------------
 name       | text    |           |          |                               | extended |              |
 sex        | boolean |           |          |                               | plain    |              |
 age        | integer |           |          |                               | plain    |              |
 class_name | text    |           |          |                               | extended |              |
 id         | bigint  |           | not null | nextval('p_id_seq'::regclass) | plain    |              |
Inherits: students

postgres=# alter table chinese_students drop column sex;
ERROR:  cannot drop inherited column "sex"

```

### 修改主表字段的存储策略
```
    create table if not exists persons(
    "name" text,
    "sex" boolean,
    "age" int
    )with(oids=false);

    create table if not exists students(
    "class_name" text
    )inherits(persons)
    with(oids=false);

    PgLearn=# \d
                    关联列表
     架构模式 |   名称   |  类型  |  拥有者
    ----------+----------+--------+----------
     public   | persons  | 数据表 | postgres
     public   | students | 数据表 | postgres
    (2 行记录)

    PgLearn=# \d+ persons
                            数据表 "public.persons"
     栏位 |  类型   | 校对规则 | 可空的 | 预设 |   存储   | 统计目标 | 描述
    ------+---------+----------+--------+------+----------+----------+------
     name | text    |          |        |      | extended |          |
     sex  | boolean |          |        |      | plain    |          |
     age  | integer |          |        |      | plain    |          |
    子表: students

    PgLearn=# \d+ students
                               数据表 "public.students"
        栏位    |  类型   | 校对规则 | 可空的 | 预设 |   存储   | 统计目标 | 描述
    ------------+---------+----------+--------+------+----------+----------+------
     name       | text    |          |        |      | extended |          |
     sex        | boolean |          |        |      | plain    |          |
     age        | integer |          |        |      | plain    |          |
     class_name | text    |          |        |      | extended |          |
    继承: persons

    修改主表 name 字段的存储策略：
      postgres=# alter table persons alter column name set storage external;
      ALTER TABLE
      postgres=# \d+ persons
                                        Table "public.persons"
       Column |  Type   | Collation | Nullable | Default | Storage  | Stats target | Description
      --------+---------+-----------+----------+---------+----------+--------------+-------------
       name   | text    |           |          |         | external |              |
       sex    | boolean |           |          |         | plain    |              |
       age    | integer |           |          |         | plain    |              |
      Child tables: students

      postgres=# \d+ students
                                          Table "public.students"
         Column   |  Type   | Collation | Nullable | Default | Storage  | Stats target | Description
      ------------+---------+-----------+----------+---------+----------+--------------+-------------
       name       | text    |           |          |         | external |              |
       sex        | boolean |           |          |         | plain    |              |
       age        | integer |           |          |         | plain    |              |
       class_name | text    |           |          |         | extended |              |
      Inherits: persons

      修改子表字段的存储策略：
      postgres=# alter table students alter column name set storage main;
      ALTER TABLE
      postgres=# \d+ persons
                                        Table "public.persons"
       Column |  Type   | Collation | Nullable | Default | Storage  | Stats target | Description
      --------+---------+-----------+----------+---------+----------+--------------+-------------
       name   | text    |           |          |         | external |              |
       sex    | boolean |           |          |         | plain    |              |
       age    | integer |           |          |         | plain    |              |
      Child tables: students

      postgres=# \d+ students
                                          Table "public.students"
         Column   |  Type   | Collation | Nullable | Default | Storage  | Stats target | Description
      ------------+---------+-----------+----------+---------+----------+--------------+-------------
       name       | text    |           |          |         | main     |              |
       sex        | boolean |           |          |         | plain    |              |
       age        | integer |           |          |         | plain    |              |
       class_name | text    |           |          |         | extended |              |
      Inherits: persons

```

### 继承的规则
#### 多继承 继承所有的列
```
    CREATE TABLE IF NOT EXISTS "foo"(
      "id" int
      )
      WITH(OIDS=FALSE)
    > OK
    > Time: 0.012s

    CREATE TABLE IF NOT EXISTS "foo_2"(
      "name" text
      )
      WITH(OIDS=FALSE)
    > OK
    > Time: 0.013s

    CREATE TABLE IF NOT EXISTS "son"(
      "school" text
      )inherits(foo, foo_2)
      WITH(OIDS=FALSE)
    > OK
    > Time: 0.007s

    -- 查看子表表结构
    postgres=# \d+ son
                                        Table "public.son"
     Column |  Type   | Collation | Nullable | Default | Storage  | Stats target | Description
    --------+---------+-----------+----------+---------+----------+--------------+-------------
     id     | integer |           |          |         | plain    |              |
     name   | text    |           |          |         | extended |              |
     school | text    |           |          |         | extended |              |
    Inherits: foo,
              foo_2

```

#### 出现重名的列 - 数据类型一致
````
    CREATE TABLE IF NOT EXISTS "foo"(
    "id" int
    )
    WITH(OIDS=FALSE);

    CREATE TABLE IF NOT EXISTS "foo_2"(
    "id" int
    )
    WITH(OIDS=FALSE);

    CREATE TABLE IF NOT EXISTS "son"(
    "id" int
    )inherits(foo, foo_2)
    WITH(OIDS=FALSE);

    -- 执行结果(Navicat)
    CREATE TABLE IF NOT EXISTS "foo"(
    "id" int
    )
    WITH(OIDS=FALSE)
    > OK
    > Time: 0.017s

    CREATE TABLE IF NOT EXISTS "foo_2"(
    "id" int
    )
    WITH(OIDS=FALSE)
    > OK
    > Time: 0.005s

    CREATE TABLE IF NOT EXISTS "son"(
    "id" int
    )inherits(foo, foo_2)
    WITH(OIDS=FALSE)
    > NOTICE:  merging multiple inherited definitions of column "id"

      NOTICE:  merging column "id" with inherited definition

    查看子表表结构
      postgres=# \d+ son
                                      Table "public.son"
       Column |  Type   | Collation | Nullable | Default | Storage | Stats target | Description
      --------+---------+-----------+----------+---------+---------+--------------+-------------
       id     | integer |           |          |         | plain   |              |
      Inherits: foo,
                foo_2
````

#### 出现重名的列 - 数据类型不一致
````
    CREATE TABLE IF NOT EXISTS "foo"(
        "id" int2
        )
        WITH(OIDS=FALSE)
    > OK
    > Time: 0.012s

    CREATE TABLE IF NOT EXISTS "foo_2"(
        "id" int4
        )
        WITH(OIDS=FALSE)
    > OK
    > Time: 0.006s

    CREATE TABLE IF NOT EXISTS "son"(
        "id" int8
        )inherits(foo, foo_2)
        WITH(OIDS=FALSE)
    > ERROR:  inherited column "id" has a type conflict
      DETAIL:  smallint versus integer

    > Time: 0.004s

````
#### 约束的继承规则 - 非空约束 - 可被继承
```
    CREATE TABLE IF NOT EXISTS "foo"(
    "id" int2 NOT NULL
    )
    WITH(OIDS=FALSE);

    CREATE TABLE IF NOT EXISTS "son"(
    )inherits(foo)
    WITH(OIDS=FALSE);

    -- 查看表结构
    postgres=# \d+ foo
                                    Table "public.foo"
     Column |   Type   | Collation | Nullable | Default | Storage | Stats target | Description
    --------+----------+-----------+----------+---------+---------+--------------+-------------
     id     | smallint |           | not null |         | plain   |              |
    Child tables: son

    postgres=# \d+ son
                                        Table "public.son"
     Column |   Type   | Collation | Nullable | Default | Storage | Stats target | Description
    --------+----------+-----------+----------+---------+---------+--------------+-------------
     id     | smallint |           | not null |         | plain   |              |
    Inherits: foo
```
#### 约束的继承规则 - 检查约束 - 可被继承
```
    CREATE TABLE IF NOT EXISTS "foo"(
    "id" int2  CHECK(id>10)
    )
    WITH(OIDS=FALSE);

    CREATE TABLE IF NOT EXISTS "son"(
    )inherits(foo)
    WITH(OIDS=FALSE);

    -- 查看表结构
    postgres=# \d+ foo
                                    Table "public.foo"
     Column |   Type   | Collation | Nullable | Default | Storage | Stats target | Description
    --------+----------+-----------+----------+---------+---------+--------------+-------------
     id     | smallint |           |          |         | plain   |              |
    Check constraints:
        "foo_id_check" CHECK (id > 10)
    Child tables: son

    postgres=# \d+ son
                                        Table "public.son"
     Column |   Type   | Collation | Nullable | Default | Storage | Stats target | Description
    --------+----------+-----------+----------+---------+---------+--------------+-------------
     id     | smallint |           |          |         | plain   |              |
    Check constraints:
        "foo_id_check" CHECK (id > 10)
    Inherits: foo
```
#### 约束的继承规则 - 唯一约束 - 不被继承
```
    CREATE TABLE IF NOT EXISTS "foo"(
    "id" int2,
    "name" text,
    CONSTRAINT must_different_unique UNIQUE(id,name)
    )
    WITH(OIDS=FALSE);

    CREATE TABLE IF NOT EXISTS "son"(
    )inherits(foo)
    WITH(OIDS=FALSE);

    -- 查看表结构
    postgres=# \d+ foo
                                         Table "public.foo"
     Column |   Type   | Collation | Nullable | Default | Storage  | Stats target | Description
    --------+----------+-----------+----------+---------+----------+--------------+-------------
     id     | smallint |           |          |         | plain    |              |
     name   | text     |           |          |         | extended |              |
    Indexes:
        "must_different_unique" UNIQUE CONSTRAINT, btree (id, name)
    Child tables: son

    postgres=# \d+ son
                                         Table "public.son"
     Column |   Type   | Collation | Nullable | Default | Storage  | Stats target | Description
    --------+----------+-----------+----------+---------+----------+--------------+-------------
     id     | smallint |           |          |         | plain    |              |
     name   | text     |           |          |         | extended |              |
    Inherits: foo

```
#### 约束的继承规则 - 主键约束 - 不被继承
```
    CREATE TABLE IF NOT EXISTS "foo"(
    "id" int2 primary key
    )
    WITH(OIDS=FALSE);

    CREATE TABLE IF NOT EXISTS "son"(
    )inherits(foo)
    WITH(OIDS=FALSE);

    -- 查看表结构
    postgres=# \d+ foo
                                        Table "public.foo"
     Column |   Type   | Collation | Nullable | Default | Storage | Stats target | Description
    --------+----------+-----------+----------+---------+---------+--------------+-------------
     id     | smallint |           | not null |         | plain   |              |
    Indexes:
        "foo_pkey" PRIMARY KEY, btree (id)
    Child tables: son

    postgres=# \d+ son
                                        Table "public.son"
     Column |   Type   | Collation | Nullable | Default | Storage | Stats target | Description
    --------+----------+-----------+----------+---------+---------+--------------+-------------
     id     | smallint |           | not null |         | plain   |              |
    Inherits: foo
```
#### 约束的继承规则 - 外键约束 - 不被继承
```
    CREATE TABLE IF NOT EXISTS "super_foo"(
    "super_id" int2 PRIMARY KEY
    )
    WITH(OIDS=FALSE);

    CREATE TABLE IF NOT EXISTS "foo"(
    "id" int2 references super_foo(super_id)
    )
    WITH(OIDS=FALSE);

    CREATE TABLE IF NOT EXISTS "son"(
    )inherits(foo)
    WITH(OIDS=FALSE);

    -- 查看表结构

    postgres=# \d+ super_foo
                                      Table "public.super_foo"
      Column  |   Type   | Collation | Nullable | Default | Storage | Stats target | Description
    ----------+----------+-----------+----------+---------+---------+--------------+-------------
     super_id | smallint |           | not null |         | plain   |              |
    Indexes:
        "super_foo_pkey" PRIMARY KEY, btree (super_id)
    Referenced by:
        TABLE "foo" CONSTRAINT "foo_id_fkey" FOREIGN KEY (id) REFERENCES super_foo(super_id)

    postgres=# \d+ foo
                                        Table "public.foo"
     Column |   Type   | Collation | Nullable | Default | Storage | Stats target | Description
    --------+----------+-----------+----------+---------+---------+--------------+-------------
     id     | smallint |           |          |         | plain   |              |
    Foreign-key constraints:
        "foo_id_fkey" FOREIGN KEY (id) REFERENCES super_foo(super_id)
    Child tables: son

    postgres=# \d+ son
                                        Table "public.son"
     Column |   Type   | Collation | Nullable | Default | Storage | Stats target | Description
    --------+----------+-----------+----------+---------+---------+--------------+-------------
     id     | smallint |           |          |         | plain   |              |
    Inherits: foo

```
### 主表存储参数的继承规则
```
    create table if not exists persons(
    "name" text,
    "sex" boolean,
    "age" int
    )with(oids=false
    ,fillfactor=60
    ,parallel_workers=5);

    create table if not exists students(
    "class_name" text
    )inherits(persons)
    with(oids=false);

    postgres=# \d+ persons
                                      Table "public.persons"
     Column |  Type   | Collation | Nullable | Default | Storage  | Stats target | Description
    --------+---------+-----------+----------+---------+----------+--------------+-------------
     name   | text    |           |          |         | extended |              |
     sex    | boolean |           |          |         | plain    |              |
     age    | integer |           |          |         | plain    |              |
    Child tables: students
    Options: fillfactor=60, parallel_workers=5

    postgres=# \d+ students
                                        Table "public.students"
       Column   |  Type   | Collation | Nullable | Default | Storage  | Stats target | Description
    ------------+---------+-----------+----------+---------+----------+--------------+-------------
     name       | text    |           |          |         | extended |              |
     sex        | boolean |           |          |         | plain    |              |
     age        | integer |           |          |         | plain    |              |
     class_name | text    |           |          |         | extended |              |
    Inherits: persons


```

### 表继承知识点总结
```
    0) 子表会从主表中继承主表的所有列，子表也可以定义自己的列。
    1) 一个表可以从0个或者多个表中继承。这种情况下子表拥有所有父表和自己所定义的列的并集。如果这个并集中出现了重名的列，
       那么这些列会被合并成一列。重名列能合并的前提是必须拥有一致的数据类型。否则会报错。合并之后的列将会从被合并的列
       中复制所有的约束。
    2) 父表的所有检查约束和非空约束会被子表继承，但是其他类型的约束(主键、唯一约束、外键约束)则不会被继承。default 会被继承。
    3) 主表增加字段，子表也会增加该字段，但是主键等约束不会继承。修改主表的表名称可以影响到后代表。子表不允许删除继承过来的字段，主表可以删除字段，并且影响所有后代表。
        主表修改字段的数据类型将影响所有的后代，子表不允许修改继承过来的字段的数据类型。
    4) 序列也会继承。
    5) 修改主表字段的存储策略，子表该字段的存储策略同样也会改变。但是如果在子表中修改继承过来的字段的存储策略则主表相应的字段的存储策略并不会改变。
    6) 主表的存储参数不会被子表继承。
    7) reindex 和 vacuum 命令不会影响到子表。
    8) 继承多张表时，相同名称的字段来说。default 默认值不一样报错。check约束没有问题会合并所有的check约束。

```

## 添加继承和删除继承
### 把指定的表添加成一个主表的子表。
#### 目标表必须包含和主表完全相同的字段。目标表也可以有自己的字段。
```
    create table if not exists persons(
    "name" text DEFAULT 'zhangsan',
    "sex" boolean DEFAULT true,
    "age" int
    );

    create table if not exists students(
    "name" text,
    "sex" boolean,
    "age" int
    )

    postgres=# alter table students inherit persons;
    ALTER TABLE
```
#### 这些字段必须有匹配的数据类型。
```
    举例：
        create table if not exists persons(
        "name" text,
        "sex" boolean,
        "age" int
        );

        create table if not exists students(
        "name" text,
        "sex" boolean,
        "age" int2
        );

        postgres=# alter table students inherit persons;
        ERROR:  child table "students" has different type for column "age"

```
#### 如果主表中有 not null 约束，目标表上相应字段也是not null.
```
CREATE TABLE IF	NOT EXISTS persons (
"name" TEXT DEFAULT 'zhangsan',
"sex" BOOLEAN DEFAULT TRUE,
"age" INT not null
);
CREATE TABLE IF	NOT EXISTS students (
"name" TEXT,
"sex" BOOLEAN,
"age" INT
);

postgres=# alter table students inherit persons;
ERROR:  column "age" in child table must be marked NOT NULL

```

#### 主表有check约束，目的表上相应字段也必须有check约束，并且目的表上的约束名称必须和主表一致。

```
CREATE TABLE IF	NOT EXISTS persons (
"name" TEXT DEFAULT 'zhangsan',
"sex" BOOLEAN DEFAULT TRUE,
"age" INT CHECK ( age > 10 )
);
CREATE TABLE IF	NOT EXISTS students (
"name" TEXT,
"sex" BOOLEAN,
"age" INT
);

postgres=# alter table students inherit persons;
ERROR:  child table is missing constraint "persons_age_check"


      CREATE TABLE IF	NOT EXISTS persons (
      "name" TEXT DEFAULT 'zhangsan',
      "sex" BOOLEAN DEFAULT TRUE,
      "age" INT CHECK ( age > 10 )
      );
      CREATE TABLE IF	NOT EXISTS students (
      "name" TEXT,
      "sex" BOOLEAN,
      "age" INT,
      constraint persons_age_check check (age>10)
      );

      postgres=# alter table students inherit persons;
      ALTER TABLE
      postgres=# \d+ persons
                                             Table "public.persons"
       Column |  Type   | Collation | Nullable |     Default      | Storage  | Stats target | Description
      --------+---------+-----------+----------+------------------+----------+--------------+-------------
       name   | text    |           |          | 'zhangsan'::text | extended |              |
       sex    | boolean |           |          | true             | plain    |              |
       age    | integer |           |          |                  | plain    |              |
      Check constraints:
          "persons_age_check" CHECK (age > 10)
      Child tables: students

      postgres=# \d+ students
                                        Table "public.students"
       Column |  Type   | Collation | Nullable | Default | Storage  | Stats target | Description
      --------+---------+-----------+----------+---------+----------+--------------+-------------
       name   | text    |           |          |         | extended |              |
       sex    | boolean |           |          |         | plain    |              |
       age    | integer |           |          |         | plain    |              |
      Check constraints:
          "persons_age_check" CHECK (age > 10)
      Inherits: persons

```

#### 主键约束.只要保证对应字段的数据类型和非空即可。
```
--主表存在主键
CREATE TABLE IF	NOT EXISTS persons (
"id" bigserial primary key,
"name" TEXT DEFAULT 'zhangsan',
"sex" BOOLEAN DEFAULT TRUE,
"age" INT
);
CREATE TABLE IF	NOT EXISTS students (
"id" int8 not null,
"name" TEXT,
"sex" BOOLEAN,
"age" INT
);

postgres=# alter table students inherit persons;
ALTER TABLE
postgres=# \d+ persons
                                                Table "public.persons"
 Column |  Type   | Collation | Nullable |               Default               | Storage  | Stats target | Description
--------+---------+-----------+----------+-------------------------------------+----------+--------------+-------------
 id     | bigint  |           | not null | nextval('persons_id_seq'::regclass) | plain    |              |
 name   | text    |           |          | 'zhangsan'::text                    | extended |              |
 sex    | boolean |           |          | true                                | plain    |              |
 age    | integer |           |          |                                     | plain    |              |
Indexes:
    "persons_pkey" PRIMARY KEY, btree (id)
Child tables: students

postgres=# \d+ students
                                  Table "public.students"
 Column |  Type   | Collation | Nullable | Default | Storage  | Stats target | Description
--------+---------+-----------+----------+---------+----------+--------------+-------------
 id     | bigint  |           | not null |         | plain    |              |
 name   | text    |           |          |         | extended |              |
 sex    | boolean |           |          |         | plain    |              |
 age    | integer |           |          |         | plain    |              |
Inherits: persons


--子表存在主键
postgres=# alter table students inherit persons;
ALTER TABLE
postgres=# \d+ persons
                                       Table "public.persons"
 Column |  Type   | Collation | Nullable |     Default      | Storage  | Stats target | Description
--------+---------+-----------+----------+------------------+----------+--------------+-------------
 id     | bigint  |           | not null |                  | plain    |              |
 name   | text    |           |          | 'zhangsan'::text | extended |              |
 sex    | boolean |           |          | true             | plain    |              |
 age    | integer |           |          |                  | plain    |              |
Child tables: students

postgres=# \d+ students
                                                Table "public.students"
 Column |  Type   | Collation | Nullable |               Default                | Storage  | Stats target | Description
--------+---------+-----------+----------+--------------------------------------+----------+--------------+-------------
 id     | bigint  |           | not null | nextval('students_id_seq'::regclass) | plain    |              |
 name   | text    |           |          |                                      | extended |              |
 sex    | boolean |           |          |                                      | plain    |              |
 age    | integer |           |          |                                      | plain    |              |
Indexes:
    "students_pkey" PRIMARY KEY, btree (id)
Inherits: persons
```
#### 唯一约束，没有关系。
```
CREATE TABLE IF	NOT EXISTS persons (
"name" TEXT UNIQUE,
"sex" BOOLEAN DEFAULT TRUE,
"age" INT
);
CREATE TABLE IF	NOT EXISTS students (
"name" TEXT,
"sex" BOOLEAN,
"age" INT
);

postgres=# alter table students inherit persons;
ALTER TABLE
postgres=# \d+ persons
                                  Table "public.persons"
 Column |  Type   | Collation | Nullable | Default | Storage  | Stats target | Description
--------+---------+-----------+----------+---------+----------+--------------+-------------
 name   | text    |           |          |         | extended |              |
 sex    | boolean |           |          | true    | plain    |              |
 age    | integer |           |          |         | plain    |              |
Indexes:
    "persons_name_key" UNIQUE CONSTRAINT, btree (name)
Child tables: students

postgres=# \d+ students
                                  Table "public.students"
 Column |  Type   | Collation | Nullable | Default | Storage  | Stats target | Description
--------+---------+-----------+----------+---------+----------+--------------+-------------
 name   | text    |           |          |         | extended |              |
 sex    | boolean |           |          |         | plain    |              |
 age    | integer |           |          |         | plain    |              |
Inherits: persons

```

## 继承表的查询


## 继承表的修改

有时候你可能想知道某个行版本来自哪个表。在每个表里我们都有一个tableoid 系统属性可以告诉你源表是谁：

SELECT c.tableoid, c.name, c.altitude
FROM cities c
WHERE c.altitude > 500;
结果如下(你可能会得到不同的 OID)：

 tableoid |   name    | altitude
----------+-----------+----------
   139793 | Las Vegas |     2174
   139793 | Mariposa  |     1953
   139798 | Madison   |      845
通过和pg_class做一个连接，就可以看到实际的表名字：

SELECT p.relname, c.name, c.altitude
FROM cities c, pg_class p
WHERE c.altitude > 500 AND c.tableoid = p.oid;
它返回：

 relname  |   name    | altitude
----------+-----------+----------
 cities   | Las Vegas |     2174
 cities   | Mariposa  |     1953
 capitals | Madison   |      845

 对于INSERT或COPY，继承并不自动影响其后代表。在我们的例子里，下面的INSERT语句将会失败：

INSERT INTO cities (name, population, altitude, state)
VALUES ('New York', NULL, NULL, 'NY');
我们可能希望数据被传递到capitals表里面去，但这是不会发生的：INSERT总是插入明确声明的那个表。在某些情况下，我们可以使用规则进行重定向插入。不过它不能对上面的例子有什么帮助，因为cities表并不包含state 字段，因此命令在规则施加之前就会被拒绝掉。

所有父表的检查约束和非空约束都会自动被所有子表继承。不过其它类型的约束(唯一、主键、外键约束)不会被继承。

一个子表可以从多个父表继承，这种情况下它将拥有所有父表字段的总和，并且子表中定义的字段也会加入其中。如果同一个字段名出现在多个父表中，或者同时出现在父表和子表的定义里，那么这些字段就会被"融合"，这样在子表里就只有一个这样的字段。要想融合，字段的数据类型必须相同，否则就会抛出一个错误。融合的字段将会拥有其父字段的所有检查约束，并且如果某个父字段存在非空约束，那么融合后的字段也必须是非空的。
